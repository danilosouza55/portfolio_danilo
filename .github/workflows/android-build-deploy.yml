name: Build Android APK & Deploy to Google Play Store

on:
  push:
    branches:
      - main
    paths:
      - 'pubspec.yaml'
      - 'lib/**'
      - 'android/**'
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  build:
    name: Build Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: gradle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run Flutter analyze
        run: flutter analyze

      - name: Build APK (Debug)
        run: flutter build apk --debug

      - name: Build APK (Release)
        run: flutter build apk --release

      - name: Build Bundle (for Play Store)
        run: flutter build appbundle --release

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-apk
          path: |
            build/app/outputs/apk/release/app-release.apk
            build/app/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: Upload Bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-bundle
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  deploy-play-store:
    name: Deploy to Google Play Store
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Bundle
        run: flutter build appbundle --release

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
          working-directory: android

      - name: Install Fastlane
        run: cd android && gem install fastlane

      - name: Decode and setup Service Account JSON
        run: |
          mkdir -p android/fastlane
          echo "${{ secrets.PLAY_STORE_SERVICE_ACCOUNT }}" | base64 --decode > android/fastlane/service_account.json

      - name: Setup Keystore
        run: |
          mkdir -p android/app
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Create Fastlane credentials
        run: |
          cat > android/fastlane/Fastfile << 'EOF'
          default_platform(:android)

          platform :android do
            desc "Upload to Google Play Store"
            lane :internal do
              upload_to_play_store(
                aab: '../build/app/outputs/bundle/release/app-release.aab',
                json_key: './service_account.json',
                track: 'internal',
                rollout: 0.1,
                skip_upload_images: true,
                skip_upload_screenshots: true,
                skip_upload_metadata: true
              )
            end

            desc "Upload to Closed Testing track"
            lane :closed_testing do
              upload_to_play_store(
                aab: '../build/app/outputs/bundle/release/app-release.aab',
                json_key: './service_account.json',
                track: 'beta',
                rollout: 0.25,
                skip_upload_images: true,
                skip_upload_screenshots: true,
                skip_upload_metadata: true
              )
            end

            desc "Upload to Production"
            lane :production do
              upload_to_play_store(
                aab: '../build/app/outputs/bundle/release/app-release.aab',
                json_key: './service_account.json',
                track: 'production',
                rollout: 1.0,
                skip_upload_images: true,
                skip_upload_screenshots: true,
                skip_upload_metadata: true
              )
            end
          end
          EOF

      - name: Upload to Play Store (Internal Testing)
        run: cd android && fastlane android internal

      - name: Create Release
        uses: actions/create-release@v1
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            Portfólio Android Build
            - Build number: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Build date: $(date)
            
            Build artifacts available in Actions tab.
          draft: false
          prerelease: true

      - name: Notify Success
        if: success()
        run: |
          echo "✅ Build and Deploy successful!"
          echo "App uploaded to Google Play Store (Internal Testing track)"

      - name: Notify Failure
        if: failure()
        run: |
          echo "❌ Build or Deploy failed!"
          echo "Check the workflow logs for details"
